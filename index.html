<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BHUGOLIKA Portal - Master Technology</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg: #0a0e27;
            --card: #151932;
            --card-hover: #1e2444;
            --accent: #f5c84c;
            --primary: #4a69ff;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --text: #ffffff;
            --text-muted: #94a3b8;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-text: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --sidebar-width: 260px;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body {
            background-color: #050714;
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* ==================== ENHANCED BACKGROUND ==================== */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(118, 75, 162, 0.15), transparent 60%);
            z-index: -3;
        }
        body::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(74, 105, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(74, 105, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px; z-index: -2; pointer-events: none;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }
        .bg-blob {
            position: fixed; border-radius: 50%; filter: blur(80px); z-index: -3;
            opacity: 0.4; animation: moveBlob 20s infinite alternate;
        }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--primary); }
        .blob-2 { bottom: -10%; right: -10%; width: 40vw; height: 40vw; background: var(--secondary); animation-delay: -5s; }
        .blob-3 { top: 40%; left: 40%; width: 30vw; height: 30vw; background: var(--accent); animation-delay: -10s; }

        @keyframes moveBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, 50px) scale(1.1); }
        }
        /* =============================================================== */
        
        /* Particles */
        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; pointer-events: none; }
        .particle {
            position: absolute; width: 4px; height: 4px; background: var(--accent); border-radius: 50%;
            opacity: 0.4; animation: floatParticle 20s infinite linear;
        }
        @keyframes floatParticle { 0% { transform: translateY(100vh) translateX(0); opacity: 0; } 50% { opacity: 0.4; } 100% { transform: translateY(-100vh) translateX(50px); opacity: 0; } }
        
        /* Theme Toggle */
        .theme-toggle {
            position: fixed; top: 100px; right: 30px; width: 60px; height: 60px;
            border-radius: 50%; background: var(--gradient); border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            color: white; box-shadow: var(--shadow); transition: var(--transition); z-index: 1000;
        }
        .theme-toggle:hover { transform: scale(1.1) rotate(180deg); }
        
        /* Loader */
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.8s ease;
        }
        .loader.hidden { opacity: 0; pointer-events: none; }
        .loader-circle {
            width: 80px; height: 80px; border: 4px solid rgba(245, 200, 76, 0.2);
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Navigation */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 40px; background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .logo {
            font-size: 28px; font-weight: 900; display: flex; align-items: center; gap: 12px;
            background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer;
        }
        nav ul { display: flex; gap: 8px; list-style: none; }
        nav li {
            cursor: pointer; color: var(--text-muted); padding: 12px 20px;
            border-radius: 30px; transition: var(--transition); font-weight: 500;
            position: relative; overflow: hidden;
        }
        nav li::before {
            content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: var(--gradient); transition: left 0.4s ease; z-index: -1;
        }
        nav li:hover::before { left: 0; }
        nav li:hover { color: var(--text); transform: translateY(-2px); }
        nav li.active { background: var(--gradient); color: #fff; font-weight: 600; }
        .menu-toggle { display: none; font-size: 28px; cursor: pointer; color: var(--text); background: rgba(255, 255, 255, 0.1); border: none; padding: 10px 15px; border-radius: 10px; }

        /* mobile nav improvements */
        nav ul { transition: transform 0.25s ease; }
        nav ul.active { transform: translateY(0); }
        
        /* Sections */
        section {
            display: none; animation: fadeInUp 0.6s ease; padding: 60px 0;
            min-height: calc(100vh - 100px);
        }
        section.active { display: block; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* General UI */
        .btn {
            padding: 14px 28px; border: none; border-radius: 12px; cursor: pointer;
            font-weight: 600; transition: var(--transition); display: inline-flex;
            align-items: center; justify-content: center; gap: 10px; font-size: 16px;
            text-decoration: none; position: relative; overflow: hidden;
        }
        .btn-main { background: var(--gradient); color: #fff; box-shadow: 0 10px 20px rgba(74, 105, 255, 0.3); }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(74, 105, 255, 0.4); }
        .btn-dark { background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: #fff; }

        input, textarea, select {
            width: 100%; padding: 16px; border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; background: rgba(255, 255, 255, 0.03);
            color: var(--text); font-size: 16px; transition: var(--transition);
        }
        input:focus, textarea:focus {
            outline: none; background: rgba(255, 255, 255, 0.08); border-color: var(--accent);
        }

        .card {
            background: rgba(20, 25, 50, 0.6); backdrop-filter: blur(15px);
            padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: var(--glass-border); transition: var(--transition);
        }
        .card:hover { transform: translateY(-5px); border-color: rgba(255, 255, 255, 0.2); }

        /* ================== ADVANCED HOME STYLES ================== */
        .home-wrapper {
            width: 90%; max-width: 1400px; margin: 0 auto; position: relative; z-index: 1;
        }

        /* Hero Section */
        .hero-advanced {
            display: flex; align-items: center; justify-content: space-between;
            min-height: 85vh; padding: 40px 0;
            perspective: 1000px; /* For 3D effects */
        }

        .hero-text {
            flex: 1; padding-right: 50px; z-index: 2;
        }

        .hero-badge {
            display: inline-block; background: rgba(74, 105, 255, 0.15);
            color: var(--primary); padding: 8px 16px; border-radius: 50px;
            font-size: 14px; font-weight: 600; margin-bottom: 20px;
            border: 1px solid rgba(74, 105, 255, 0.3);
            box-shadow: 0 0 15px rgba(74, 105, 255, 0.2);
        }

        .hero-title {
            /* responsive font sizing */
            font-size: clamp(28px, 6vw, 72px); line-height: 1.1; font-weight: 800;
            margin-bottom: 25px;
            background: var(--gradient-text);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }

        .hero-desc {
            font-size: 18px; color: var(--text-muted); margin-bottom: 40px;
            max-width: 600px; line-height: 1.7;
        }

        .hero-buttons { display: flex; gap: 20px; }

        /* Hero Visuals (Floating 3D Cards) */
        .hero-visual {
            flex: 1; position: relative; height: 500px;
            display: flex; align-items: center; justify-content: center;
            transform-style: preserve-3d;
        }

        /* Hero photographer / credit */
        /* hero photo removed - reverted to original design */

        .floating-card {
            position: absolute; background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: floatY 6s ease-in-out infinite;
        }

        /* restore original translucent floating card so background blur shows through */
        .fc-main { width: 280px; height: 350px; z-index: 3; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02)); }
        .fc-sub-1 { width: 180px; height: 180px; top: 10%; left: -10%; z-index: 2; animation-delay: 1s; }
        .fc-sub-2 { width: 150px; height: 150px; bottom: 10%; right: -5%; z-index: 4; animation-delay: 2s; }

        .fc-icon { font-size: 60px; color: var(--accent); margin-bottom: 15px; }
        .fc-text { font-weight: 700; font-size: 18px; margin-bottom: 5px; }
        .fc-sub { font-size: 12px; color: var(--text-muted); }

        @keyframes floatY {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* Holographic Stats */
        .holo-stats {
            display: flex; justify-content: space-between; gap: 20px;
            margin-top: -50px; position: relative; z-index: 10; flex-wrap: wrap;
        }
        .holo-stat-box {
            flex: 1; min-width: 200px; background: rgba(21, 25, 50, 0.8);
            backdrop-filter: blur(20px); border: var(--glass-border);
            border-radius: 20px; padding: 25px; text-align: center;
            position: relative; overflow: hidden;
        }
        .holo-stat-box::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: var(--gradient);
        }
        .holo-num { font-size: 32px; font-weight: 800; color: var(--accent); margin-bottom: 5px; }
        .holo-label { font-size: 14px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* Trending Categories Grid */
        .trending-section { margin-top: 100px; }
        .section-header { margin-bottom: 40px; display: flex; justify-content: space-between; align-items: end; }
        .section-title { font-size: 32px; font-weight: 700; color: #fff; }
        .section-subtitle { color: var(--primary); font-weight: 600; }

        .cat-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px;
        }

        .cat-card {
            background: rgba(20, 25, 50, 0.4); border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px; padding: 30px; cursor: pointer; transition: var(--transition);
            position: relative; overflow: hidden; group: hover;
        }
        .cat-card:hover {
            background: rgba(30, 36, 68, 0.8); transform: translateY(-10px);
            border-color: var(--primary); box-shadow: 0 10px 30px rgba(74, 105, 255, 0.15);
        }
        .cat-icon {
            width: 60px; height: 60px; border-radius: 15px; background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: var(--secondary); margin-bottom: 20px;
            transition: var(--transition);
        }
        .cat-card:hover .cat-icon { background: var(--secondary); color: #fff; }
        .cat-name { font-size: 20px; font-weight: 700; margin-bottom: 10px; }
        .cat-count { font-size: 13px; color: var(--text-muted); }

        /* Profile & Other Sections (Keeping them same as before) */
        .profile-container { width: 90%; max-width: 1000px; margin: 40px auto; display: grid; grid-template-columns: 300px 1fr; gap: 30px; }
        .profile-sidebar { background: rgba(20, 25, 50, 0.6); backdrop-filter: blur(20px); border-radius: 20px; padding: 40px 20px; text-align: center; border: var(--glass-border); display: flex; flex-direction: column; align-items: center; }
        .profile-pic-large { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 20px; object-fit: cover; box-shadow: 0 0 20px rgba(245, 200, 76, 0.3); }
        .uid-badge { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 18px; font-weight: 800; letter-spacing: 1px; margin: 10px 0; display: inline-block; box-shadow: 0 5px 15px rgba(74, 105, 255, 0.3); }
        .profile-main-content { display: flex; flex-direction: column; gap: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-box { background: rgba(255, 255, 255, 0.03); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.05); }
        .stat-number { font-size: 28px; font-weight: 700; color: var(--accent); margin-bottom: 5px; }
        .activity-list { list-style: none; }
        .activity-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 10px; background: rgba(74, 105, 255, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; margin-right: 15px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .data-table-container { background: var(--card); border-radius: 20px; border: var(--glass-border); overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        /* allow horizontal scroll on smaller screens */
        .data-table-container { overflow-x: auto; }
        .data-table { min-width: 700px; }

        /* make images generally responsive */
        img { max-width: 100%; height: auto; display: block; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: rgba(0,0,0,0.3); padding: 20px; text-align: left; font-weight: 600; color: var(--text-muted); }
        .data-table td { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text); }

        /* Auth */
        .auth-container { width: 90%; max-width: 900px; margin: 40px auto; background: rgba(21, 25, 50, 0.95); border-radius: 30px; box-shadow: var(--shadow); display: flex; min-height: 550px; border: var(--glass-border); backdrop-filter: blur(10px); }
        .auth-visuals { flex: 1; background: var(--gradient); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 40px; }
        .auth-forms { flex: 1; padding: 50px; display: flex; flex-direction: column; justify-content: center; }
        
        /* Admin */
        .admin-dashboard { display: none; width: 100%; height: calc(100vh - 100px); margin-top: -40px; padding-top: 40px; background: rgba(0,0,0,0.2); }
        .sidebar { width: var(--sidebar-width); background: rgba(21, 25, 50, 0.95); border-right: 1px solid rgba(255,255,255,0.05); padding: 20px; display: flex; flex-direction: column; height: 100%; }
        .nav-item { display: flex; align-items: center; padding: 15px 20px; color: var(--text-muted); border-radius: 12px; cursor: pointer; transition: var(--transition); margin-bottom: 10px; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: var(--gradient); color: #fff; }
        .nav-item i { width: 30px; margin-right: 10px; }
        .admin-content { flex: 1; padding: 40px; overflow-y: auto; }
        .admin-form-card { background: var(--card); padding: 25px; border-radius: 20px; border: var(--glass-border); margin-bottom: 30px; }
        .admin-search-box { position: relative; margin-bottom: 20px; }
        .admin-search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .admin-search-box input { padding-left: 45px; }

        /* Notification */
        .notification {
            position: fixed; top: 100px; right: 30px; padding: 20px 25px; border-radius: 15px;
            background: rgba(21, 25, 50, 0.95); box-shadow: var(--shadow);
            transform: translateX(150%); transition: transform 0.5s; z-index: 2000;
            display: flex; align-items: center; gap: 15px; max-width: 350px;
            backdrop-filter: blur(10px); border: var(--glass-border);
        }
        .notification.show { transform: translateX(0); }
        .notification.success { border-left: 5px solid var(--success); }
        .notification.error { border-left: 5px solid var(--danger); }

        /* Responsive */
        @media (min-width: 768px) { .auth-visuals { display: flex; } }
        @media (max-width: 1100px) {
            .hero-title { font-size: 48px; }
            .hero-advanced { flex-direction: column; text-align: center; padding-top: 100px; }
            .hero-text { padding-right: 0; margin-bottom: 50px; }
            .hero-buttons { justify-content: center; }
            .hero-visual { height: 400px; width: 100%; }
            .hero-photo-card { max-width: 70%; }
        }

        @media (max-width: 600px) {
            .hero-title { font-size: 34px; }
            .hero-photo-card img { height: 160px; }
            .btn { padding: 12px 18px; font-size: 15px; }
            nav { padding: 12px 18px; }
            .profile-container { grid-template-columns: 1fr; }
            .data-table th, .data-table td { padding: 12px; }
            .admin-content { padding: 20px; }
            .sidebar { display: none; }
            .menu-toggle { display: block; }
            .nav-item { padding: 12px; }
            .hero-visual { height: auto; }
        }

        /* extra small screens (phones) */
        @media (max-width: 420px) {
            body { font-size: 14px; }
            .hero-title { font-size: clamp(22px, 8vw, 40px); }
            .hero-desc { font-size: 13px; }
            .btn { padding: 10px 14px; font-size: 14px; }
            .profile-pic-large { width: 64px; height: 64px; border-width: 3px; }
            .profile-sidebar { padding: 12px; }
            .card { padding: 14px; border-radius: 10px; }
            .data-table th, .data-table td { padding: 10px; font-size: 13px; }
            .fc-main { width: 220px; height: 280px; }
            .fc-sub-1, .fc-sub-2 { display: none; }
            .hero-visual { padding-bottom: 12px; }
            .nav li { padding: 10px 12px; font-size: 14px; }
            .notification { right: 8px; left: 8px; }
            .admin-content { padding: 12px; }
            .notes input, .notes textarea, #noteTitle, #noteContent { font-size: 14px; }
        }

        /* Support chat styles */
        .chat-fab { position: fixed; right: 18px; bottom: 18px; width: 56px; height: 56px; border-radius: 50%; background: var(--gradient); color: #fff; display:flex; align-items:center; justify-content:center; z-index: 4000; box-shadow: 0 8px 20px rgba(0,0,0,0.3); cursor:pointer; }
        .chat-modal { position: fixed; right: 20px; bottom: 90px; width: 360px; max-width: 95%; height: 480px; background: var(--card); border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 4001; display: none; flex-direction: column; overflow: hidden; }
        .chat-header { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.04); display:flex; justify-content:space-between; align-items:center; }
        .chat-body { flex:1; padding: 12px; overflow-y: auto; display:flex; flex-direction:column; gap:8px; }
        .chat-input { padding: 10px; border-top: 1px solid rgba(255,255,255,0.04); display:flex; gap:8px; }
        .chat-input input { flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color:var(--text); }
        .chat-msg.user { align-self: flex-end; background: linear-gradient(90deg, rgba(74,105,255,0.14), rgba(139,92,246,0.08)); padding:8px 12px; border-radius:12px; max-width:85%; }
        .chat-msg.admin { align-self: flex-start; background: rgba(255,255,255,0.02); padding:8px 12px; border-radius:12px; max-width:85%; }
        @media (max-width: 900px) {
            .admin-dashboard { flex-direction: column; height: auto; margin-top: 0; padding-top: 0; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; }
            .menu-toggle { display: block; }
            nav ul { display: none; position: fixed; top: 80px; left: 0; width: 100%; background: var(--card); flex-direction: column; padding: 20px; }
            nav ul.active { display: flex; }
            .profile-container { grid-template-columns: 1fr; }
            .profile-sidebar { flex-direction: row; text-align: left; padding: 20px; }
            .profile-pic-large { margin-bottom: 0; margin-right: 20px; width: 80px; height: 80px; }
            .profile-info-side { text-align: left; }
        }
    </style>
</head>
<body>
    <!-- Background Elements -->
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>
    <div class="particles" id="particles"></div>
    
    <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></button>
    
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="loader-circle"></div>
            <div class="loader-text">Loading BHUGOLIKA Portal...</div>
        </div>
    </div>

    <nav>
        <div class="logo" onclick="show('home')">
            <i class="fas fa-microchip"></i>
            <span><span style="color:var(--accent)">B</span>HUGOLIKA</span>
        </div>
        <ul id="navMenu">
            <li onclick="show('home')"><i class="fas fa-home"></i> Home</li>
            <li onclick="show('library')"><i class="fas fa-book"></i> Library</li>
            <li onclick="show('quiz')"><i class="fas fa-brain"></i> Quiz</li>
            <li onclick="show('notes')"><i class="fas fa-sticky-note"></i> Notes</li>
            <li id="navProfile" style="display:none;" onclick="show('profile')"><i class="fas fa-user-circle"></i> Profile</li>
            <li id="navAdmin" style="display:none;" onclick="show('admin')"><i class="fas fa-user-shield"></i> Admin</li>
            <li id="navLogin" onclick="show('auth')"><i class="fas fa-sign-in-alt"></i> Login</li>
        </ul>
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
    </nav>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Success message</span>
    </div>

    <!-- AUTH SECTION -->
    <section id="auth">
        <div class="auth-container" data-aos="fade-up">
            <div class="auth-visuals">
                <i class="fas fa-laptop-code" style="font-size: 80px; margin-bottom: 20px; opacity: 0.8;"></i>
                <h2>Welcome Back</h2>
                <p>Access your dashboard and start learning.</p>
            </div>
            <div class="auth-forms">
                <h2 style="font-size: 32px; margin-bottom: 20px; color: white; text-align: center;">Login</h2>
                <form onsubmit="handleEmailLogin(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600;">Email</label>
                        <input type="email" id="loginEmail" required placeholder="name@example.com">
                    </div>
                    <div style="margin-bottom: 30px;">
                        <label style="display:block; margin-bottom:8px; font-weight:600;">Password</label>
                        <input type="password" id="loginPassword" required placeholder="********">
                    </div>
                    <button type="submit" class="btn btn-main" style="width: 100%;">Login</button>
                    <button type="button" class="btn btn-dark" style="width: 100%; margin-top: 15px;" onclick="handleGoogleLogin()"><i class="fab fa-google"></i> Google Login</button>
                    <p style="text-align: center; margin-top: 20px; font-size: 14px; color: var(--text-muted);">
                        Don't have an account? <span style="color: var(--accent); cursor: pointer;" onclick="handleRegisterView()">Register</span>
                    </p>
                </form>
                
                <form id="registerForm" style="display: none;" onsubmit="handleRegister(event)">
                    <h2 style="font-size: 32px; margin-bottom: 20px; color: white; text-align: center;">Create Account</h2>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="regName" required placeholder="Full Name">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="email" id="regEmail" required placeholder="Email Address">
                    </div>
                    <div style="margin-bottom: 30px;">
                        <input type="password" id="regPassword" required placeholder="Password (Min 6 chars)" minlength="6">
                    </div>
                    <button type="submit" class="btn btn-main" style="width: 100%;">Register</button>
                    <p style="text-align: center; margin-top: 20px; font-size: 14px; color: var(--text-muted);">
                        Already have an account? <span style="color: var(--accent); cursor: pointer;" onclick="handleLoginView()">Login</span>
                    </p>
                </form>
            </div>
        </div>
    </section>
    <!-- Support Chat: user floating button & modal -->
    <div class="chat-fab" title="Support" onclick="toggleSupportChat()"><i class="fas fa-comments"></i></div>
    <div id="supportChatModal" class="chat-modal" style="display:none; flex-direction:column;">
        <div class="chat-header"><div><strong>Support</strong><div style="font-size:12px;color:var(--text-muted)">Get help from admin</div></div><div><button class="btn btn-dark" onclick="toggleSupportChat()">Close</button></div></div>
        <div id="supportChatBody" class="chat-body"></div>
        <div class="chat-input"><input id="supportChatInput" placeholder="Type your message..." onkeydown="if(event.key==='Enter'){ sendSupportMessage(); }"><button class="btn btn-main" onclick="sendSupportMessage()">Send</button></div>
    </div>

    <!-- Admin: User Notes Modal -->
    <div id="userNotesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3000; align-items:center; justify-content:center;">
        <div style="width:95%; max-width:760px; margin:40px auto; background:var(--card); border-radius:12px; padding:20px; border:var(--glass-border);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 id="modalUserName">User Notes</h3>
                <div>
                    <button class="btn btn-dark" onclick="closeUserNotesModal()">Close</button>
                </div>
            </div>
            <div id="modalUserInfo" style="margin-bottom:12px; color:var(--text-muted);"></div>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
                <button id="modalBlockBtn" class="btn btn-danger" onclick="adminToggleBlock(currentModalUser)">Block</button>
                <span style="color:var(--text-muted); font-size:13px;">(Admin can remove user notes and block/unblock user from here)</span>
            </div>
            <h4 style="margin-top:6px;">Notes</h4>
            <div id="modalUserNotesList"></div>
        </div>
    </div>

    <!-- ================== ADVANCED HOME SECTION ================== -->
    <section id="home" class="active">
        <div class="home-wrapper">
            
            <!-- Hero Section -->
            <div class="hero-advanced" data-aos="fade-up">
                <div class="hero-text">
                    <div class="hero-badge"><i class="fas fa-rocket"></i> V 2.0 Is Live</div>
                    <h1 class="hero-title">Master the <br>Future of <span style="color: var(--accent)">Tech</span></h1>
                    <p class="hero-desc">Access premium PDFs, solve competitive quizzes, and track your progress with our advanced analytics dashboard. Start your journey today.</p>
                    <div class="hero-buttons">
                        <button class="btn btn-main" onclick="checkAuthAndRedirect('library')"><i class="fas fa-book-open"></i> Explore Library</button>
                        <button class="btn btn-dark" onclick="checkAuthAndRedirect('quiz')"><i class="fas fa-play"></i> Start Quiz</button>
                    </div>
                </div>

                <!-- 3D Floating Visuals -->
                <div class="hero-visual">
                    <!-- hero photo removed, restored original floating visuals -->
                    <div class="floating-card fc-main">
                        <i class="fas fa-code fc-icon"></i>
                        <div class="fc-text">Coding</div>
                        <div class="fc-sub">Python, Java, C++</div>
                    </div>
                    <div class="floating-card fc-sub-1">
                        <i class="fas fa-globe-asia fc-icon" style="color:var(--success)"></i>
                        <div class="fc-text">Geography</div>
                    </div>
                    <div class="floating-card fc-sub-2">
                        <i class="fas fa-history fc-icon" style="color:var(--secondary)"></i>
                        <div class="fc-text">History</div>
                    </div>
                </div>
            </div>

            <!-- Holographic Stats -->
            <div class="holo-stats" data-aos="fade-up" data-aos-delay="200">
                <div class="holo-stat-box">
                    <div class="holo-num">1.2k+</div>
                    <div class="holo-label">Students</div>
                </div>
                <div class="holo-stat-box">
                    <div class="holo-num">500+</div>
                    <div class="holo-label">PDFs</div>
                </div>
                <div class="holo-stat-box">
                    <div class="holo-num">4.9</div>
                    <div class="holo-label">User Rating</div>
                </div>
                <div class="holo-stat-box">
                    <div class="holo-num">24/7</div>
                    <div class="holo-label">Support</div>
                </div>
            </div>

            <!-- Trending Categories -->
            <div class="trending-section" data-aos="fade-up">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Trending Topics</h2>
                        <span class="section-subtitle">Most popular this week</span>
                    </div>
                    <button class="btn btn-dark" onclick="checkAuthAndRedirect('library')">View All</button>
                </div>

                <div class="cat-grid">
                    <div class="cat-card" onclick="checkAuthAndRedirect('library')">
                        <div class="cat-icon"><i class="fab fa-python"></i></div>
                        <h3 class="cat-name">Python Masterclass</h3>
                        <p class="cat-count">120 PDFs • 45 Quizzes</p>
                    </div>
                    <div class="cat-card" onclick="checkAuthAndRedirect('library')">
                        <div class="cat-icon"><i class="fas fa-network-wired"></i></div>
                        <h3 class="cat-name">Computer Networks</h3>
                        <p class="cat-count">80 PDFs • 30 Quizzes</p>
                    </div>
                    <div class="cat-card" onclick="checkAuthAndRedirect('library')">
                        <div class="cat-icon"><i class="fas fa-database"></i></div>
                        <h3 class="cat-name">DBMS & SQL</h3>
                        <p class="cat-count">95 PDFs • 50 Quizzes</p>
                    </div>
                    <div class="cat-card" onclick="checkAuthAndRedirect('library')">
                        <div class="cat-icon"><i class="fas fa-map-marked-alt"></i></div>
                        <h3 class="cat-name">World Geography</h3>
                        <p class="cat-count">150 PDFs • 60 Quizzes</p>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- LIBRARY SECTION -->
    <section id="library">
        <div style="width: 90%; max-width: 1200px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px;">PDF Library</h2>
            <input type="text" id="searchInput" placeholder="Search PDFs..." style="margin-bottom: 20px; max-width: 400px;">
            <div class="data-table-container">
                <table class="data-table">
                    <thead><tr><th>Title</th><th>Category</th><th>Action</th></tr></thead>
                    <tbody id="pdfList"><tr><td colspan="3" style="text-align: center;">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- QUIZ SECTION -->
    <section id="quiz">
        <div class="card" style="width: 90%; max-width: 800px; margin: 40px auto;">
            <h2 style="text-align: center; margin-bottom: 30px;">Technology Quiz</h2>
            <div id="quizQuestion" style="font-size: 22px; margin-bottom: 30px; font-weight: 600; text-align: center;">Loading...</div>
            <div id="quizOptions" class="grid" style="grid-template-columns: 1fr;"></div>
            <button class="btn btn-main" style="margin-top: 30px; width: 100%;" onclick="nextQuestion()">Next Question</button>
        </div>
    </section>

    <!-- NOTES SECTION -->
    <section id="notes">
        <div style="width: 90%; max-width: 800px; margin: 40px auto;">
            <h2 style="margin-bottom: 20px;">My Notes</h2>

            <div class="card admin-form-card" style="margin-bottom:16px;">
                <input id="noteTitle" placeholder="Title" style="margin-bottom:10px;">
                <textarea id="noteContent" style="width:100%; min-height:160px; margin-bottom:12px;" placeholder="Write your note here..."></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-main" onclick="addNote()"><i class="fas fa-save"></i> Save Note</button>
                    <button class="btn btn-dark" onclick="document.getElementById('noteTitle').value=''; document.getElementById('noteContent').value=''">Clear</button>
                </div>
            </div>

            <div style="margin-top:10px;">
                <h3 style="margin-bottom:10px;">My Notes</h3>
                <div id="myNotesList"></div>
            </div>
        </div>
    </section>

    <!-- ================== PROFILE SECTION ================== -->
    <section id="profile">
        <div class="profile-container">
            <div class="profile-sidebar">
                <img id="profilePic" src="" alt="Profile" class="profile-pic-large">
                <div style="margin-top:10px; display:flex; gap:10px; align-items:center; justify-content:center; width:100%;">
                    <input type="file" id="avatarFile" accept="image/*" style="display:none" onchange="uploadAvatar(event)">
                    <button class="btn btn-main" onclick="document.getElementById('avatarFile').click()" style="font-size:13px; padding:8px 12px;"><i class="fas fa-camera"></i> Upload</button>
                    <button class="btn btn-dark" onclick="removeAvatar()" style="font-size:13px; padding:8px 12px;"><i class="fas fa-trash"></i> Remove</button>
                </div>
                <div style="flex: 1; text-align: center;" class="profile-info-side">
                    <h2 id="profileName" style="font-size: 24px;">User Name</h2>
                    <p id="profileEmail" style="color: var(--text-muted); font-size: 14px; margin-bottom: 10px;">email@example.com</p>
                    <div class="uid-badge" id="profileUid">00000</div>
                </div>
                <button class="btn btn-danger" onclick="handleLogout()" style="margin-top: 20px; width: 100%; font-size: 14px;"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            <div class="profile-main-content">
                <div class="card">
                    <h3 style="margin-bottom: 20px; font-size: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Account Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-box"><i class="fas fa-calendar-alt" style="color: var(--secondary); font-size: 24px; margin-bottom: 10px;"></i><div class="stat-number" id="profileMemberSince">0 Days</div><div style="font-size: 12px; color: var(--text-muted);">Member Since</div></div>
                        <div class="stat-box"><i class="fas fa-sticky-note" style="color: var(--accent); font-size: 24px; margin-bottom: 10px;"></i><div class="stat-number" id="profileNotesCount">0</div><div style="font-size: 12px; color: var(--text-muted);">Notes Saved</div></div>
                        <div class="stat-box"><i class="fas fa-trophy" style="color: var(--warning); font-size: 24px; margin-bottom: 10px;"></i><div class="stat-number">Beginner</div><div style="font-size: 12px; color: var(--text-muted);">Current Level</div></div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 20px; font-size: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Account Settings</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-dark" onclick="showNotification('Edit Profile feature coming soon!', 'info')"><i class="fas fa-edit"></i> Edit Profile</button>
                        <button class="btn btn-dark" onclick="showNotification('Password reset link sent!', 'success')"><i class="fas fa-key"></i> Change Password</button>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 20px; font-size: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Recent Activity</h3>
                    <ul class="activity-list" id="activityLog">
                        <li class="activity-item"><div class="activity-icon"><i class="fas fa-sign-in-alt"></i></div><div class="activity-details"><h4>Logged In</h4><span>Just now</span></div></li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- ADMIN SECTION -->
    <section id="admin">
        <div id="adminLoginOverlay" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px;">
            <div class="card" style="width: 100%; max-width: 400px; text-align: center;">
                <i class="fas fa-lock" style="font-size: 40px; color: var(--accent); margin-bottom: 20px;"></i>
                <h2>Admin Access</h2>
                <input type="password" id="adminPass" placeholder="Password" style="margin: 20px 0;">
                <button class="btn btn-main" style="width: 100%;" onclick="loginAdmin()">Unlock</button>
            </div>
        </div>
        <div id="adminDashboard" class="admin-dashboard" style="display: none;">
            <div class="sidebar">
                <div class="nav-item active" onclick="switchAdminTab('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
                <div class="nav-item" onclick="switchAdminTab('pdfs', this)"><i class="fas fa-file-pdf"></i> Manage PDFs</div>
                <div class="nav-item" onclick="switchAdminTab('quiz', this)"><i class="fas fa-brain"></i> Quiz Manager</div>
                <div class="nav-item" onclick="switchAdminTab('users', this)"><i class="fas fa-users"></i> Users</div>
                <div class="nav-item" onclick="switchAdminTab('support', this)"><i class="fas fa-headset"></i> Support</div>
                <div class="nav-item" onclick="show('home')" style="margin-top: auto; color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Exit</div>
            </div>
            <div class="admin-content">
                <div id="tab-dashboard" class="admin-tab-content">
                    <h2>Admin Dashboard</h2>
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-box"><div id="dashTotalUsers">0</div><div>Users</div></div>
                        <div class="stat-box"><div id="dashTotalPdfs">0</div><div>PDFs</div></div>
                        <div class="stat-box"><div id="dashTotalQuestions">0</div><div>Questions</div></div>
                    </div>
                </div>
                <div id="tab-support" class="admin-tab-content" style="display:none;">
                    <h2>Support Messages</h2>
                    <div style="display:flex; gap:16px; margin-top:16px;">
                        <div style="width:280px; max-width:30%;">
                            <div class="admin-form-card">
                                <h4>Conversations</h4>
                                <div id="supportUserList" style="max-height:420px; overflow:auto;"></div>
                            </div>
                        </div>
                        <div style="flex:1;">
                            <div class="admin-form-card" style="display:flex; flex-direction:column; height:520px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><h4 id="supportConvTitle">Select a user</h4><small id="supportConvMeta" style="color:var(--text-muted)"></small></div>
                                <div id="supportConvMessages" style="flex:1; overflow:auto; padding:6px; background: rgba(255,255,255,0.01); border-radius:8px;"></div>
                                <div style="margin-top:10px; display:flex; gap:8px;">
                                    <input id="supportReplyInput" placeholder="Write a reply..." style="flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color:var(--text);">
                                    <button class="btn btn-main" onclick="adminSendSupportReply()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-pdfs" class="admin-tab-content" style="display: none;">
                    <h2>Manage PDFs</h2>
                    <div class="admin-form-card">
                        <h3>Add New PDF</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <input type="text" id="adminPdfTitle" placeholder="PDF Title">
                            <input type="text" id="adminPdfCategory" placeholder="Category">
                        </div>
                        <textarea id="adminPdfDesc" placeholder="Description" style="margin: 20px 0; height: 100px;"></textarea>
                        <input type="url" id="adminPdfUrl" placeholder="Direct PDF Link (https://...)" style="margin-bottom: 20px;">
                        <button class="btn btn-main" onclick="adminAddPDF()"><i class="fas fa-plus"></i> Add PDF</button>
                    </div>
                    <div class="admin-search-box"><i class="fas fa-search"></i><input type="text" id="adminPdfSearch" placeholder="Search PDFs..." onkeyup="filterTable('adminPdfList', 'adminPdfSearch')"></div>
                    <div class="data-table-container"><table class="data-table"><thead><tr><th>Title</th><th>Category</th><th>Views</th><th>Action</th></tr></thead><tbody id="adminPdfList"></tbody></table></div>
                </div>
                <div id="tab-quiz" class="admin-tab-content" style="display: none;">
                    <h2>Quiz Manager</h2>
                    <div class="admin-form-card">
                        <h3>Add New Question</h3>
                        <input type="text" id="quizQ" placeholder="Question Text" style="margin-bottom: 20px;">
                        <div class="quiz-option-input-group"><input type="radio" name="correctOpt" value="0" checked><input type="text" id="opt0" placeholder="Option A"></div>
                        <div class="quiz-option-input-group"><input type="radio" name="correctOpt" value="1"><input type="text" id="opt1" placeholder="Option B"></div>
                        <div class="quiz-option-input-group"><input type="radio" name="correctOpt" value="2"><input type="text" id="opt2" placeholder="Option C"></div>
                        <div class="quiz-option-input-group"><input type="radio" name="correctOpt" value="3"><input type="text" id="opt3" placeholder="Option D"></div>
                        <button class="btn btn-main" style="margin-top: 20px;" onclick="adminAddQuestion()"><i class="fas fa-plus"></i> Add Question</button>
                    </div>
                    <div class="admin-search-box"><i class="fas fa-search"></i><input type="text" id="adminQuizSearch" placeholder="Search Questions..." onkeyup="filterTable('adminQuizList', 'adminQuizSearch')"></div>
                    <div class="data-table-container"><table class="data-table"><thead><tr><th>Question</th><th>Correct</th><th>Action</th></tr></thead><tbody id="adminQuizList"></tbody></table></div>
                </div>
                <div id="tab-users" class="admin-tab-content" style="display: none;">
                    <h2>User Management</h2>
                    <div class="admin-search-box"><i class="fas fa-search"></i><input type="text" id="adminUserSearch" placeholder="Search Users..." onkeyup="filterTable('adminUserList', 'adminUserSearch')"></div>
                    <div class="data-table-container"><table class="data-table"><thead><tr><th>Photo</th><th>User</th><th>Email</th><th>UID</th><th>Action</th></tr></thead><tbody id="adminUserList"></tbody></table></div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- Supabase JS (replace keys below) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <script>
        AOS.init({ duration: 800, once: true });

                // ---------------- SUPABASE SETUP ------------------
                // Using the Supabase values you provided. anon key is fine for client ops.
                // Bucket name for avatars: `profile-pics` (you said you created it and set it public)
                const SUPABASE_URL = 'https://vcxojnqbwimsjuucatyj.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjeG9qbnFid2ltc2p1dWNhdHlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDkwOTEsImV4cCI6MjA4MjQyNTA5MX0.rerfLuJdfbR8e93XYTcd4EnXRrrc74QOUSYtw9-5p18';
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                /*
                SQL to create `profiles` table (run in Supabase SQL editor):

                -- If you use Supabase Auth, you can reference auth.users(id):
                -- create table profiles (
                --   id uuid primary key references auth.users(id) on delete cascade,
                --   name text,
                --   email text,
                --   avatar_url text,
                --   is_admin boolean default false,
                --   created_at timestamptz default now()
                -- );

                -- If you keep using Firebase Auth (like this project currently does),
                -- create a text id primary key (store firebase UID):
                create table profiles (
                    id text primary key,
                    name text,
                    email text,
                    avatar_url text,
                    is_admin boolean default false,
                    created_at timestamptz default now()
                );

                Also: create a storage bucket named `profile-pics` and make it public (or
                set proper policies). If the bucket is private, use signed URLs to serve images.
                */

                // run a quick storage access check (logs to console)
                checkStorageAccess();


        const firebaseConfig = {
            apiKey: "AIzaSyAlgrKArihDhA20GKZFYs9oo5kxX1jYm8I",
            authDomain: "ok-hub-845b2.firebaseapp.com",
            databaseURL: "https://ok-hub-845b2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ok-hub-845b2",
            storageBucket: "ok-hub-845b2.firebasestorage.app",
            messagingSenderId: "146569981748",
            appId: "1:146569981748:web:7e2ef5ab43899d3ea9ff61",
            measurementId: "G-P0JJ2BWDQQ"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const rtdb = firebase.database();
        const ADMIN_EMAIL = "dev.ali.soet@gmail.com";

        let isAdminLoggedIn = false;
        let currentQuizIndex = 0;
        let quizQuestionsData = [];

        // --- UI ---
        window.addEventListener('load', () => {
            createParticles();
            setTimeout(() => document.getElementById('loader').classList.add('hidden'), 1000);
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
        });

        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('navMenu').classList.toggle('active');
        });

        function createParticles() {
            const container = document.getElementById('particles');
            for(let i=0; i<40; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random()*100 + '%';
                p.style.animationDuration = (15 + Math.random()*20) + 's';
                p.style.animationDelay = Math.random()*5 + 's';
                container.appendChild(p);
            }
        }

        function showNotification(msg, type) {
            const n = document.getElementById('notification');
            n.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i><span>${msg}</span>`;
            n.className = `notification show ${type}`;
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        function show(id) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));
            const activeLi = document.querySelector(`nav li[onclick="show('${id}')"]`);
            if(activeLi) activeLi.classList.add('active');
            
            document.getElementById('navMenu').classList.remove('active');

            if(id === 'library') loadLibrary();
            if(id === 'quiz') loadQuizFromDB();
            if(id === 'notes') loadNotes();
            if(id === 'profile' && auth.currentUser) loadProfileStats();
        }

        function checkAuthAndRedirect(id) {
            if(auth.currentUser) show(id);
            else { showNotification('Please Login First', 'info'); show('auth'); }
        }

        // --- AUTH ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('navLogin').style.display = 'none';
                document.getElementById('navProfile').style.display = 'flex';
                if(user.email === ADMIN_EMAIL) document.getElementById('navAdmin').style.display = 'flex';

                // Load Firebase DB user info
                rtdb.ref('users/' + user.uid).once('value').then(snap => {
                    const data = snap.val();
                    if(data && !data.isBlocked) {
                        document.getElementById('profileName').innerText = data.name;
                        document.getElementById('profileEmail').innerText = data.email;
                        if(data.customID) document.getElementById('profileUid').innerText = data.customID;
                        // set a fallback photo from RTDB; Supabase avatar may override below
                        if(data.photo) document.getElementById('profilePic').src = data.photo;
                    } else if (data && data.isBlocked) {
                        auth.signOut(); alert('You are blocked.');
                    }
                });

                // Ensure a row exists in Supabase `profiles` and load avatar if present
                ensureSupabaseProfile(user);
                // Load user's notes in Notes tab
                loadMyNotes();
            } else {
                document.getElementById('navLogin').style.display = 'flex';
                document.getElementById('navProfile').style.display = 'none';
                document.getElementById('navAdmin').style.display = 'none';
            }
        });

        function handleRegisterView() {
            document.querySelector('.auth-forms form').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }
        function handleLoginView() {
            document.querySelector('.auth-forms form').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function generateUnique5DigitID() {
            return Math.floor(10000 + Math.random() * 90000).toString();
        }

        function handleEmailLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, pass)
                .then(() => { show('home'); showNotification('Welcome back!', 'success'); })
                .catch(err => showNotification(err.message, 'error'));
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPassword').value;
            const customID = generateUnique5DigitID();
            
            auth.createUserWithEmailAndPassword(email, pass)
                .then((cred) => {
                    cred.user.updateProfile({ displayName: name });
                    rtdb.ref('users/' + cred.user.uid).set({
                        name: name, email: email, photo: `https://ui-avatars.com/api/?name=${name}&background=random`, role: 'user', isBlocked: false, customID: customID, joinedAt: Date.now()
                    });
                        // ensure profile in Supabase (avatar will be ui-avatars fallback)
                        ensureSupabaseProfile(cred.user);
                    show('home');
                    showNotification('Account created!', 'success');
                })
                .catch(err => showNotification(err.message, 'error'));
        }

        function handleGoogleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    const userRef = rtdb.ref('users/' + result.user.uid);
                    userRef.once('value').then(snapshot => {
                        let data = snapshot.val();
                        let customID = data ? data.customID : generateUnique5DigitID();
                        let joinedAt = data ? data.joinedAt : Date.now();
                        userRef.set({
                            name: result.user.displayName, email: result.user.email, photo: result.user.photoURL, role: 'user', isBlocked: false, customID: customID, joinedAt: joinedAt
                        });
                        // ensure profile row exists in Supabase
                        ensureSupabaseProfile(result.user);
                        show('home');
                        showNotification('Logged in', 'success');
                    });
                })
                .catch(err => showNotification(err.message, 'error'));
        }

        function handleLogout() {
            auth.signOut().then(() => {
                show('auth');
                showNotification('Logged out', 'info');
            });
        }

        // --- FEATURES ---
        function seedDatabase() {
            rtdb.ref('pdfs').set({ "pdf1": { title: "Python Basics", category: "Programming", url: "#", views: 0 }, "pdf2": { title: "Geography Maps", category: "Geography", url: "#", views: 0 }, "pdf3": { title: "History Timeline", category: "History", url: "#", views: 0 } });
            rtdb.ref('quizzes').set({ "q1": { q: "What is 2+2?", options: ["3", "4", "5", "6"], correct: 1 }, "q2": { q: "Capital of France?", options: ["Berlin", "Madrid", "Paris", "Rome"], correct: 2 } });
            showNotification("Database Seeded", "success");
            setTimeout(() => window.location.reload(), 1500);
        }

        function loadLibrary() {
            rtdb.ref('pdfs').on('value', snap => {
                const list = document.getElementById('pdfList');
                list.innerHTML = '';
                const data = snap.val();
                if(!data) { list.innerHTML = '<tr><td colspan="3">No PDFs</td></tr>'; return; }
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    list.innerHTML += `<tr><td><strong>${item.title}</strong></td><td>${item.category}</td><td><a href="${item.url}" target="_blank" class="btn btn-main" style="padding: 5px 15px; font-size: 12px;">View</a></td></tr>`;
                });
            });
        }

        function loadQuizFromDB() {
            rtdb.ref('quizzes').once('value').then(snap => {
                const data = snap.val();
                if(!data) { document.getElementById('quizQuestion').innerText = "No questions."; return; }
                quizQuestionsData = Object.keys(data).map(k => data[k]);
                currentQuizIndex = 0;
                renderQuizQuestion();
            });
        }

        function renderQuizQuestion() {
            if(currentQuizIndex >= quizQuestionsData.length) {
                document.getElementById('quizQuestion').innerText = "Quiz Completed!";
                document.getElementById('quizOptions').innerHTML = `<button class="btn btn-main" onclick="loadQuizFromDB()">Restart</button>`;
                return;
            }
            const q = quizQuestionsData[currentQuizIndex];
            document.getElementById('quizQuestion').innerText = `${currentQuizIndex + 1}. ${q.q}`;
            const optsHtml = q.options.map((opt, idx) => `
                <div class="card" id="q-opt-${idx}" onclick="checkAnswer(this, ${idx}, ${q.correct})" style="cursor:pointer; text-align:center; padding: 20px;">
                    ${String.fromCharCode(65 + idx)}. ${opt}
                </div>
            `).join('');
            document.getElementById('quizOptions').innerHTML = optsHtml;
        }

        function checkAnswer(el, selected, correct) {
            document.querySelectorAll('#quizOptions .card').forEach(c => { c.style.background = ""; c.style.borderColor = ""; c.style.pointerEvents = "none"; });
            if(selected === correct) {
                el.style.background = "rgba(16, 185, 129, 0.2)";
                el.style.borderColor = "var(--success)";
                showNotification("Correct!", "success");
            } else {
                el.style.background = "rgba(239, 68, 68, 0.2)";
                el.style.borderColor = "var(--danger)";
                const correctEl = document.getElementById(`q-opt-${correct}`);
                if(correctEl) { correctEl.style.background = "rgba(16, 185, 129, 0.2)"; correctEl.style.borderColor = "var(--success)"; }
            }
        }

        function nextQuestion() { currentQuizIndex++; renderQuizQuestion(); }

        // Notes: migrate from single-text notes to per-user note objects
        function loadNotes() {
            // show user's notes list and keep it in sync
            loadMyNotes();
        }

        // Create a new note for the logged in user
        function addNote() {
            if(!auth.currentUser) return showNotification('Login first', 'error');
            const uid = auth.currentUser.uid;
            const title = document.getElementById('noteTitle').value.trim() || 'Untitled';
            const content = document.getElementById('noteContent').value.trim();
            if(!content) return showNotification('Note is empty', 'error');
            const ref = rtdb.ref('notes/' + uid).push();
            const note = { id: ref.key, title, content, createdAt: Date.now(), updatedAt: Date.now() };
            ref.set(note).then(() => {
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                showNotification('Note saved', 'success');
                // loadMyNotes will update via realtime listener
            }).catch(err => showNotification('Save failed', 'error'));
        }

        function loadMyNotes() {
            if(!auth.currentUser) return; const uid = auth.currentUser.uid;
            const list = document.getElementById('myNotesList');
            rtdb.ref('notes/' + uid).on('value', snap => {
                const data = snap.val(); list.innerHTML = '';
                if(!data) { list.innerHTML = '<div style="color:var(--text-muted)">No notes yet.</div>'; document.getElementById('profileNotesCount').innerText = '0'; return; }
                // update profile notes count
                document.getElementById('profileNotesCount').innerText = String(snap.numChildren());
                Object.keys(data).reverse().forEach(nid => {
                    const n = data[nid];
                    const date = new Date(n.updatedAt || n.createdAt || Date.now()).toLocaleString();
                    list.innerHTML += `<div class="card" style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><strong>${escapeHtml(n.title||'Untitled')}</strong><small style="color:var(--text-muted)">${date}</small></div><p style="white-space:pre-wrap;">${escapeHtml(n.content||'')}</p><div style="display:flex;gap:8px;margin-top:10px;"><button class="btn btn-dark" onclick="editMyNote('${nid}')">Edit</button><button class="btn btn-danger" onclick="deleteMyNote('${nid}')">Delete</button></div></div>`;
                });
            });
        }

        function editMyNote(nid) {
            if(!auth.currentUser) return showNotification('Login first', 'error');
            const uid = auth.currentUser.uid;
            rtdb.ref('notes/' + uid + '/' + nid).once('value').then(snap => {
                const n = snap.val();
                if(!n) return showNotification('Note not found', 'error');
                const newTitle = prompt('Edit title', n.title || '');
                if(newTitle === null) return; // cancelled
                const newContent = prompt('Edit content', n.content || '');
                if(newContent === null) return;
                rtdb.ref('notes/' + uid + '/' + nid).update({ title: newTitle, content: newContent, updatedAt: Date.now() }).then(() => {
                    showNotification('Note updated', 'success');
                }).catch(() => showNotification('Update failed', 'error'));
            });
        }

        function deleteMyNote(nid) {
            if(!auth.currentUser) return showNotification('Login first', 'error');
            if(!confirm('Delete this note?')) return;
            const uid = auth.currentUser.uid;
            rtdb.ref('notes/' + uid + '/' + nid).remove().then(() => showNotification('Deleted', 'success'));
        }

        // simple escape to avoid HTML injection in notes
        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, s => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[s]);
        }

        function saveNotesToDB() {
            // Backwards-compatible: create a note from the old textarea if used
            if(!auth.currentUser) return showNotification("Login first", "error");
            const titleElem = document.getElementById('noteTitle');
            const contentElem = document.getElementById('noteContent');
            const content = (contentElem && contentElem.value.trim()) || (document.getElementById('notesArea') && document.getElementById('notesArea').value.trim());
            const title = (titleElem && titleElem.value.trim()) || 'Note';
            if(!content) return showNotification('Note is empty', 'error');
            const uid = auth.currentUser.uid;
            const ref = rtdb.ref('notes/' + uid).push();
            const note = { id: ref.key, title, content, createdAt: Date.now(), updatedAt: Date.now() };
            ref.set(note).then(() => showNotification('Note saved', 'success')).catch(() => showNotification('Save failed', 'error'));
        }

        // --- PROFILE STATS ---
        // helper: compute days from timestamp
        let _memberSinceInterval = null;
        function daysSince(ts) { return Math.floor((Date.now() - (ts || Date.now())) / (1000 * 60 * 60 * 24)); }

        function loadProfileStats() {
            if(!auth.currentUser) return;
            const uid = auth.currentUser.uid;

            // member since (live-updating every hour)
            rtdb.ref('users/' + uid + '/joinedAt').once('value').then(snap => {
                const time = snap.val() || Date.now();
                const updateMemberSince = () => {
                    const days = daysSince(time);
                    document.getElementById('profileMemberSince').innerText = days + (days === 1 ? ' Day' : ' Days');
                };
                // immediate update
                updateMemberSince();
                // clear old interval and set new hourly updater
                if(_memberSinceInterval) clearInterval(_memberSinceInterval);
                _memberSinceInterval = setInterval(updateMemberSince, 1000 * 60 * 60); // every hour
            });

            // notes count (realtime)
            const notesRef = rtdb.ref('notes/' + uid);
            notesRef.on('value', snap => {
                const count = snap.exists() ? snap.numChildren() : 0;
                document.getElementById('profileNotesCount').innerText = String(count);
            });
        }

        // --- ADMIN ---
        function loginAdmin() {
            if(document.getElementById('adminPass').value === "302003") {
                isAdminLoggedIn = true;
                document.getElementById('adminLoginOverlay').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'flex';
                loadAdminStats();
                showNotification("Admin Unlocked", "success");
            } else {
                showNotification("Wrong Password", "error");
            }
        }

        function switchAdminTab(tab, el) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            document.querySelectorAll('.admin-tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(`tab-${tab}`).style.display = 'block';
            if(tab === 'pdfs') loadAdminPDFs();
            if(tab === 'quiz') loadAdminQuiz();
            if(tab === 'users') loadAdminUsers();
            if(tab === 'support') loadAdminSupport();
        }

        function loadAdminStats() {
            rtdb.ref('users').on('value', s => document.getElementById('dashTotalUsers').innerText = s.numChildren());
            rtdb.ref('pdfs').on('value', s => document.getElementById('dashTotalPdfs').innerText = s.numChildren());
            rtdb.ref('quizzes').on('value', s => document.getElementById('dashTotalQuestions').innerText = s.numChildren());
        }

        function loadAdminPDFs() {
            rtdb.ref('pdfs').once('value').then(snap => {
                const list = document.getElementById('adminPdfList'); list.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    list.innerHTML += `<tr><td>${item.title}</td><td>${item.category}</td><td>${item.views || 0}</td><td><button onclick="deletePDF('${key}')" style="color:var(--danger); background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            });
        }

        function adminAddPDF() {
            const title = document.getElementById('adminPdfTitle').value;
            const cat = document.getElementById('adminPdfCategory').value;
            const desc = document.getElementById('adminPdfDesc').value;
            const url = document.getElementById('adminPdfUrl').value;
            if(!title || !url) return showNotification("Fill required fields", "error");
            rtdb.ref('pdfs').push({ title, category: cat, desc, url, views: 0 }).then(() => {
                showNotification("PDF Added", "success");
                document.getElementById('adminPdfTitle').value = "";
                document.getElementById('adminPdfUrl').value = "";
                loadAdminPDFs();
            });
        }

        function deletePDF(key) {
            if(confirm("Delete this PDF?")) {
                rtdb.ref('pdfs/' + key).remove().then(() => {
                    showNotification("Deleted", "success"); loadAdminPDFs();
                });
            }
        }

        function loadAdminQuiz() {
            rtdb.ref('quizzes').once('value').then(snap => {
                const list = document.getElementById('adminQuizList'); list.innerHTML = '';
                const data = snap.val(); if(!data) return;
                Object.keys(data).forEach(key => {
                    const q = data[key];
                    list.innerHTML += `<tr><td>${q.q}</td><td>${String.fromCharCode(65 + q.correct)}</td><td><button onclick="deleteQuestion('${key}')" style="color:var(--danger); background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td></tr>`;
                });
            });
        }

        // ---------------- SUPABASE HELPERS ------------------
        async function ensureSupabaseProfile(user) {
            if(!user) return;
            try {
                const uid = user.uid;
                const name = user.displayName || (await rtdb.ref('users/' + uid + '/name').once('value')).val() || '';
                const email = user.email || (await rtdb.ref('users/' + uid + '/email').once('value')).val() || '';
                // upsert profile row
                await supabaseClient.from('profiles').upsert({ id: uid, name, email }, { returning: 'minimal' });
                // fetch avatar_url if exists
                const { data, error } = await supabaseClient.from('profiles').select('avatar_url').eq('id', uid).maybeSingle();
                if(data && data.avatar_url) {
                    document.getElementById('profilePic').src = data.avatar_url;
                    // keep RTDB in sync for legacy parts of app
                    rtdb.ref('users/' + uid + '/photo').set(data.avatar_url);
                }
            } catch(err) { console.error('Supabase ensure profile error', err); }
        }

        async function uploadAvatar(e) {
            const file = e.target.files && e.target.files[0];
            if(!file) return;
            if(!auth.currentUser) return showNotification('Please login first', 'error');
            const uid = auth.currentUser.uid;
                const path = `${uid}/${Date.now()}_${file.name}`;
            showNotification('Uploading avatar...', 'info');
            try {
                console.log('Supabase upload start', { path, name: file.name, size: file.size, type: file.type });
                // include contentType to ensure the file is served correctly
                const { data: uploadData, error: uploadErr } = await supabaseClient.storage.from('profile-pics').upload(path, file, { contentType: file.type, upsert: false });
                console.log('Supabase upload response', { uploadData, uploadErr });
                if(uploadErr) {
                    console.error('Upload error details:', uploadErr);
                    // detect permission/auth issues
                    if(uploadErr.status === 401 || uploadErr.status === 403) {
                        showNotification('Upload failed: storage permission denied (401/403). Check bucket policy or authenticate with Supabase.', 'error');
                        // helpful console message for debugging
                        console.error('Permission error: ensure the `profile-pics` bucket allows uploads for anon or authenticate users via Supabase Auth.');
                        return;
                    }
                    return showNotification(uploadErr.message || 'Upload failed', 'error');
                }
                const { data: urlData } = await supabaseClient.storage.from('profile-pics').getPublicUrl(path);
                const publicUrl = urlData.publicUrl;
                // update profiles table
                await supabaseClient.from('profiles').upsert({ id: uid, name: auth.currentUser.displayName || '', email: auth.currentUser.email, avatar_url: publicUrl }, { returning: 'minimal' });
                // sync to firebase rtdb to keep legacy UI working
                rtdb.ref('users/' + uid + '/photo').set(publicUrl);
                document.getElementById('profilePic').src = publicUrl;
                showNotification('Avatar uploaded', 'success');
            } catch(err) {
                console.error('Unexpected upload error', err);
                showNotification('Upload failed (see console)', 'error');
            }
        }

        // Optional helper to check storage access (logs outcome to console)
        async function checkStorageAccess() {
            try {
                const { data, error } = await supabaseClient.storage.from('profile-pics').list('', { limit: 1 });
                if(error) {
                    console.warn('Storage list error', error);
                    if(error.status === 401 || error.status === 403) console.warn('Permission denied - uploads will likely fail without Supabase authentication or policy change.');
                } else {
                    console.log('Storage access OK (list):', data);
                }
            } catch(e) { console.error('Storage access check failed', e); }
        }

        async function removeAvatar() {
            if(!auth.currentUser) return showNotification('Please login first', 'error');
            const uid = auth.currentUser.uid;
                // set avatar_url to null
            await supabaseClient.from('profiles').upsert({ id: uid, avatar_url: null }, { returning: 'minimal' });
            // set to default ui-avatars fallback
            const fallback = `https://ui-avatars.com/api/?name=${encodeURIComponent(document.getElementById('profileName').innerText || '')}&background=random`;
            rtdb.ref('users/' + uid + '/photo').set(fallback);
            document.getElementById('profilePic').src = fallback;
            showNotification('Avatar removed', 'success');
        }

        function adminAddQuestion() {
            const qText = document.getElementById('quizQ').value;
            const opt0 = document.getElementById('opt0').value;
            const opt1 = document.getElementById('opt1').value;
            const opt2 = document.getElementById('opt2').value;
            const opt3 = document.getElementById('opt3').value;
            let correctVal = 0;
            document.querySelectorAll('input[name="correctOpt"]').forEach(r => { if(r.checked) correctVal = parseInt(r.value); });
            if(!qText || !opt0 || !opt1 || !opt2 || !opt3) return showNotification("Fill all options", "error");
            rtdb.ref('quizzes').push({ q: qText, options: [opt0, opt1, opt2, opt3], correct: correctVal }).then(() => {
                showNotification("Question Added", "success");
                document.getElementById('quizQ').value = "";
                ['opt0','opt1','opt2','opt3'].forEach(id => document.getElementById(id).value = "");
                loadAdminQuiz();
            });
        }

        function deleteQuestion(key) {
            if(confirm("Delete this question?")) {
                rtdb.ref('quizzes/' + key).remove().then(() => {
                    showNotification("Deleted", "success"); loadAdminQuiz();
                });
            }
        }

        async function loadAdminUsers() {
            // Fetch Supabase profiles to get avatar_url, then merge with RTDB users
            let supaById = {};
            let supaByEmail = {};
            try {
                const { data: supData, error } = await supabaseClient.from('profiles').select('id, email, avatar_url');
                if(error) console.warn('Could not fetch supabase profiles', error);
                if(Array.isArray(supData)) {
                    supData.forEach(p => {
                        if(!p) return;
                        if(p.id) supaById[p.id] = p;
                        if(p.email) supaByEmail[(p.email || '').toLowerCase()] = p;
                    });
                }
            } catch(err) { console.warn('Could not fetch supabase profiles', err); }

            rtdb.ref('users').once('value').then(async snap => {
                const list = document.getElementById('adminUserList'); list.innerHTML = '';
                const data = snap.val(); if(!data) return;
                for(const uid of Object.keys(data)) {
                    const u = data[uid];
                    // Prefer Supabase avatar (lookup by id or by email), fall back to RTDB photo or ui-avatars
                    let profile = supaById[uid] || supaByEmail[(u.email || '').toLowerCase()];
                    let avatar = (profile && profile.avatar_url) ? profile.avatar_url : (u.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name||'User')}&background=random`);

                    // If avatar looks like a storage path (no protocol), try to build a public url
                    if(avatar && typeof avatar === 'string' && !avatar.startsWith('http')) {
                        try {
                            const { data: urlData } = await supabaseClient.storage.from('profile-pics').getPublicUrl(avatar);
                            avatar = urlData && urlData.publicUrl ? urlData.publicUrl : avatar;
                        } catch(e) { console.warn('Could not build public URL for', avatar, e); }
                    }

                    // safe-guard: ensure a non-empty string
                    if(!avatar) avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name||'User')}&background=random`;

                    // render row
                    list.innerHTML += `<tr>
                        <td style="width:64px;"><img src="${avatar}" alt="${(u.name||'User')}-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(u.name||'User')}&background=random'" style="width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.06)"></td>
                        <td style="cursor:pointer" onclick="openUserNotes('${uid}')">${u.name || '-'}</td>
                        <td>${u.email || '-'}</td>
                        <td>${u.customID || '-'}</td>
                        <td>${u.email !== ADMIN_EMAIL ? `<button onclick="toggleBlock('${uid}', ${!!u.isBlocked})" style="color:var(--danger); background:none; border:none;">${u.isBlocked?'Unblock':'Block'}</button>` : ''}</td>
                    </tr>`;
                }
            });
        }

        function toggleBlock(uid, status) {
            rtdb.ref(`users/${uid}/isBlocked`).set(!status).then(() => {
                showNotification("Updated", "success"); loadAdminUsers();
            });
        }

        // Admin: open modal to view a user's notes and block/unblock/delete notes
        let currentModalUser = null;
        function openUserNotes(uid) {
            currentModalUser = uid;
            document.getElementById('modalUserName').innerText = 'User Notes';
            document.getElementById('modalUserInfo').innerText = 'Loading...';
            document.getElementById('modalUserNotesList').innerHTML = '';
            document.getElementById('userNotesModal').style.display = 'flex';

            // load user basic info
            rtdb.ref('users/' + uid).once('value').then(snap => {
                const u = snap.val();
                if(u) {
                    const joinedAt = u.joinedAt || null;
                    const days = joinedAt ? daysSince(joinedAt) : 0;
                    document.getElementById('modalUserName').innerText = u.name || 'User';
                    document.getElementById('modalUserInfo').innerHTML = `<div><strong>Email:</strong> ${u.email || '-'} &nbsp; <strong>UID:</strong> ${uid}</div><div style="margin-top:6px;color:var(--text-muted)"><strong>Member since:</strong> ${joinedAt ? new Date(joinedAt).toLocaleDateString() : '-'} (${days} ${days===1?'Day':'Days'})</div>`;
                    document.getElementById('modalBlockBtn').innerText = u.isBlocked ? 'Unblock' : 'Block';
                } else {
                    document.getElementById('modalUserInfo').innerText = 'User not found';
                }
            });

            // load notes
            rtdb.ref('notes/' + uid).once('value').then(snap => {
                const data = snap.val();
                const container = document.getElementById('modalUserNotesList'); container.innerHTML = '';
                const count = snap.exists() ? snap.numChildren() : 0;
                // show count in header area
                const existingInfo = document.getElementById('modalUserInfo').innerHTML || '';
                document.getElementById('modalUserInfo').innerHTML = existingInfo + `<div style="margin-top:6px;color:var(--text-muted)"><strong>Notes:</strong> ${count}</div>`;
                if(!data) { container.innerHTML = '<div style="color:var(--text-muted)">No notes.</div>'; return; }
                Object.keys(data).reverse().forEach(nid => {
                    const n = data[nid];
                    const date = new Date(n.updatedAt || n.createdAt || Date.now()).toLocaleString();
                    container.innerHTML += `<div class="card" style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><strong>${escapeHtml(n.title||'Untitled')}</strong><small style="color:var(--text-muted)">${date}</small></div><p style="white-space:pre-wrap;">${escapeHtml(n.content||'')}</p><div style="display:flex;gap:8px;margin-top:8px;"><button class="btn btn-danger" onclick="adminDeleteNote('${uid}','${nid}')">Delete</button></div></div>`;
                });
            });
        }

        function closeUserNotesModal() {
            currentModalUser = null; document.getElementById('userNotesModal').style.display = 'none';
        }

        function adminDeleteNote(uid, nid) {
            if(!confirm('Delete this note?')) return;
            rtdb.ref('notes/' + uid + '/' + nid).remove().then(() => {
                showNotification('Deleted', 'success');
                if(currentModalUser === uid) openUserNotes(uid); // refresh
            });
        }

        function adminToggleBlock(uid) {
            // get current and flip
            rtdb.ref('users/' + uid + '/isBlocked').once('value').then(snap => {
                const cur = !!snap.val();
                rtdb.ref('users/' + uid + '/isBlocked').set(!cur).then(() => {
                    showNotification(!cur ? 'User blocked' : 'User unblocked', 'success');
                    loadAdminUsers();
                    if(currentModalUser === uid) openUserNotes(uid);
                });
            });
        }

        // --- SUPPORT (User <-> Admin messaging via RTDB) ---
        // User floating chat/button (requires auth)
        function toggleSupportChat() {
            const modal = document.getElementById('supportChatModal');
            if(!modal) return;
            if(modal.style.display === 'flex') {
                modal.style.display = 'none';
                // cleanup listeners
                if(window._supportUnsub) { window._supportUnsub.off(); window._supportUnsub = null; }
            } else {
                if(!auth.currentUser) { showNotification('Please login to chat', 'info'); show('auth'); return; }
                modal.style.display = 'flex';
                loadSupportConversation(auth.currentUser.uid);
            }
        }

        function loadSupportConversation(uid) {
            const body = document.getElementById('supportChatBody'); body.innerHTML = '';
            const ref = rtdb.ref('support/' + uid);
            // detach previous
            if(window._supportUnsub) window._supportUnsub.off();
            window._supportUnsub = ref;
            ref.on('child_added', snap => {
                const m = snap.val(); if(!m) return;
                appendSupportMessage(m);
            });
            // mark user's messages as read (admin unread count cleared on read)
            ref.once('value').then(snap => {
                snap.forEach(c => {
                    const m = c.val(); if(m && m.from === 'admin') return;
                });
            });
        }

        function appendSupportMessage(m) {
            const body = document.getElementById('supportChatBody');
            if(!body) return;
            const div = document.createElement('div');
            div.className = 'chat-msg ' + (m.from === 'user' ? 'user' : 'admin');
            div.innerHTML = `<div style="font-size:13px;">${escapeHtml(m.text||'')}</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${new Date(m.createdAt||Date.now()).toLocaleString()}</div>`;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        function sendSupportMessage() {
            if(!auth.currentUser) return showNotification('Login first', 'error');
            const inp = document.getElementById('supportChatInput');
            const text = (inp && inp.value || '').trim(); if(!text) return;
            const uid = auth.currentUser.uid;
            rtdb.ref('support/' + uid).push({ from: 'user', text, createdAt: Date.now(), read: false }).then(() => {
                inp.value = '';
                showNotification('Message sent', 'success');
            });
        }

        // Admin side: list conversations and open selected convo
        let _adminActiveSupportUser = null;
        function loadAdminSupport() {
            const list = document.getElementById('supportUserList'); list.innerHTML = '<div style="color:var(--text-muted)">Loading...</div>';
            rtdb.ref('support').on('value', snap => {
                const data = snap.val(); list.innerHTML = '';
                if(!data) { list.innerHTML = '<div style="color:var(--text-muted)">No conversations</div>'; return; }
                Object.keys(data).forEach(uid => {
                    const msgs = data[uid];
                    const keys = Object.keys(msgs || {});
                    const last = msgs[keys[keys.length-1]];
                    const unread = keys.reduce((acc,k)=> acc + ((msgs[k].from==='user' && !msgs[k].read) ? 1 : 0), 0);
                    const row = document.createElement('div');
                    row.style.padding = '8px'; row.style.borderBottom = '1px solid rgba(255,255,255,0.03)'; row.style.cursor='pointer';
                    row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>${last && last.from==='user' ? 'User' : uid}</strong><div style=\"color:var(--text-muted);font-size:12px;\">${last ? escapeHtml(last.text).slice(0,60) : ''}</div></div><div style=\"text-align:right;\">${unread?`<span style=\"background:var(--danger);color:white;padding:3px 6px;border-radius:8px;font-size:12px;\">${unread}</span>`:''}<div style=\"color:var(--text-muted);font-size:11px;\">${last ? new Date(last.createdAt).toLocaleString() : ''}</div></div></div>`;
                    row.onclick = () => adminOpenSupportUser(uid);
                    list.appendChild(row);
                });
            });
        }

        function adminOpenSupportUser(uid) {
            _adminActiveSupportUser = uid;
            document.getElementById('supportConvTitle').innerText = 'Conversation: ' + uid;
            document.getElementById('supportConvMessages').innerHTML = '';
            document.getElementById('supportReplyInput').value = '';
            // load messages
            const ref = rtdb.ref('support/' + uid);
            ref.off(); // remove previous
            ref.on('child_added', snap => {
                const m = snap.val(); if(!m) return;
                const container = document.getElementById('supportConvMessages');
                const div = document.createElement('div');
                div.className = m.from === 'user' ? 'chat-msg user' : 'chat-msg admin';
                div.style.margin = '6px 0';
                div.innerHTML = `<div style="font-size:13px;">${escapeHtml(m.text||'')}</div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${new Date(m.createdAt||Date.now()).toLocaleString()}</div>`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            });
            // mark user's messages as read
            ref.once('value').then(snap => {
                snap.forEach(child => {
                    const m = child.val(); if(m && m.from === 'user' && !m.read) {
                        rtdb.ref('support/' + uid + '/' + child.key + '/read').set(true);
                    }
                });
            });
        }

        function adminSendSupportReply() {
            if(!_adminActiveSupportUser) return showNotification('Select a user first', 'error');
            const text = document.getElementById('supportReplyInput').value.trim(); if(!text) return;
            const uid = _adminActiveSupportUser;
            rtdb.ref('support/' + uid).push({ from: 'admin', text, createdAt: Date.now() }).then(() => {
                document.getElementById('supportReplyInput').value = '';
                showNotification('Reply sent', 'success');
            });
        }

        function filterTable(tableId, inputId) {
            const input = document.getElementById(inputId).value.toUpperCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName("tr");
            for (let i = 0; i < tr.length; i++) {
                let txtValue = tr[i].textContent || tr[i].innerText;
                tr[i].style.display = txtValue.toUpperCase().indexOf(input) > -1 ? "" : "none";
            }
        }

    </script>
    <!-- Footer credit removed per request -->
</body>
</html>